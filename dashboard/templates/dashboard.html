<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaePa 뉴스 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0/dist/chartjs-adapter-luxon.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 1rem;
            color: #6c757d;
        }
        .news-card {
            cursor: pointer;
        }
        .news-card:hover {
            background-color: #f8f9fa;
        }
        .sentiment-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .sentiment-positive {
            background-color: rgba(25, 135, 84, 0.15);
            color: #198754;
        }
        .sentiment-neutral {
            background-color: rgba(13, 110, 253, 0.15);
            color: #0d6efd;
        }
        .sentiment-negative {
            background-color: rgba(220, 53, 69, 0.15);
            color: #dc3545;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #495057;
            border-bottom: 2px solid transparent;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background: none;
            border-bottom: 2px solid #0d6efd;
        }
        .source-label {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        .rss-label { background-color: #d1e7dd; color: #146c43; }
        .finnhub-label { background-color: #cfe2ff; color: #084298; }
        .newsdata-label { background-color: #f8d7da; color: #b02a37; }
        #newsModal .modal-dialog {
            max-width: 800px;
        }
        .symbol-badge {
            background-color: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 5px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 30px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up"></i> JaePa 금융 뉴스 대시보드
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">대시보드</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#news-section">뉴스 목록</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#trends-section">트렌드 분석</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="stat-label">최근 7일 수집된 뉴스</div>
                        <div class="stat-value text-primary">{{ news_count }}</div>
                        <i class="bi bi-newspaper text-primary" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="stat-label">평균 감성 점수</div>
                        <div class="stat-value">
                            {% if sentiment_avg.positive > sentiment_avg.negative %}
                                <span class="text-success">{{ sentiment_avg.positive }}</span>
                            {% else %}
                                <span class="text-danger">{{ sentiment_avg.negative }}</span>
                            {% endif %}
                        </div>
                        {% if sentiment_avg.positive > sentiment_avg.negative %}
                            <i class="bi bi-emoji-smile text-success" style="font-size: 2rem;"></i>
                        {% else %}
                            <i class="bi bi-emoji-frown text-danger" style="font-size: 2rem;"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="stat-label">데이터 소스 수</div>
                        <div class="stat-value text-info">
                            {% set total_sources = 0 %}
                            {% for source_type in sources_count %}
                                {% set total_sources = total_sources + source_type.sources|length %}
                            {% endfor %}
                            {{ total_sources }}
                        </div>
                        <i class="bi bi-database-check text-info" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-8">
                <!-- 뉴스 수집 트렌드 차트 -->
                <div class="card">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-graph-up"></i> 뉴스 수집 트렌드</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary active" onclick="updateNewsChart(7)">7일</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateNewsChart(14)">14일</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateNewsChart(30)">30일</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="newsCollectionChart" height="250"></canvas>
                        <div id="newsChartLoading" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <!-- 감성 분석 파이 차트 -->
                <div class="card">
                    <div class="card-header bg-white">
                        <i class="bi bi-pie-chart"></i> 감성 분석 분포
                    </div>
                    <div class="card-body">
                        <canvas id="sentimentPieChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <!-- 긍정적 감성 상위 심볼 -->
                <div class="card">
                    <div class="card-header bg-white">
                        <i class="bi bi-graph-up-arrow text-success"></i> 긍정적 상위 심볼
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>심볼</th>
                                        <th>긍정 점수</th>
                                        <th>뉴스 수</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for symbol in symbols.positive %}
                                    <tr>
                                        <td><span class="symbol-badge">{{ symbol.symbol }}</span></td>
                                        <td>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-success" style="width: {{ symbol.score * 100 }}%"></div>
                                            </div>
                                            <small class="text-success">{{ symbol.score }}</small>
                                        </td>
                                        <td>{{ symbol.volume }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- 부정적 감성 상위 심볼 -->
                <div class="card">
                    <div class="card-header bg-white">
                        <i class="bi bi-graph-down-arrow text-danger"></i> 부정적 상위 심볼
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>심볼</th>
                                        <th>부정 점수</th>
                                        <th>뉴스 수</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for symbol in symbols.negative %}
                                    <tr>
                                        <td><span class="symbol-badge">{{ symbol.symbol }}</span></td>
                                        <td>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-danger" style="width: {{ symbol.score * 100 }}%"></div>
                                            </div>
                                            <small class="text-danger">{{ symbol.score }}</small>
                                        </td>
                                        <td>{{ symbol.volume }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4" id="news-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-newspaper"></i> 최근 뉴스 목록</span>
                            <div>
                                <select id="newsSourceFilter" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                    <option value="">모든 소스</option>
                                    <option value="rss">RSS 피드</option>
                                    <option value="finnhub">Finnhub</option>
                                    <option value="newsdata">NewsData.io</option>
                                </select>
                                <div class="btn-group ms-2">
                                    <button class="btn btn-sm btn-outline-secondary active" onclick="loadNews(7)">7일</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadNews(14)">14일</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadNews(30)">30일</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="newsList" class="list-group list-group-flush">
                            <!-- 뉴스 목록이 여기에 로드됩니다 -->
                            <div id="newsLoading" class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4" id="trends-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#sentimentTab">
                                    <i class="bi bi-graph-up"></i> 감성 트렌드
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#sourcesTab">
                                    <i class="bi bi-pie-chart"></i> 소스 분석
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="sentimentTab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">시간 경과에 따른 감성 트렌드</h5>
                                    <div>
                                        <select id="symbolFilter" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                            <option value="">모든 심볼</option>
                                            <option value="BTC">BTC (Bitcoin)</option>
                                            <option value="ETH">ETH (Ethereum)</option>
                                            <option value="AAPL">AAPL (Apple)</option>
                                            <option value="MSFT">MSFT (Microsoft)</option>
                                            <option value="GOOGL">GOOGL (Google)</option>
                                        </select>
                                        <div class="btn-group ms-2">
                                            <button class="btn btn-sm btn-outline-secondary active" onclick="updateSentimentChart(7)">7일</button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="updateSentimentChart(14)">14일</button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="updateSentimentChart(30)">30일</button>
                                        </div>
                                    </div>
                                </div>
                                <canvas id="sentimentTrendChart" height="300"></canvas>
                                <div id="sentimentChartLoading" class="loading-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="sourcesTab">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="card-title">소스 유형별 분포</h5>
                                        <canvas id="sourceTypeChart" height="250"></canvas>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="card-title">상위 뉴스 소스</h5>
                                        <div id="topSourcesList" class="list-group">
                                            {% for source_type in sources_count %}
                                                <div class="list-group-item">
                                                    <h6 class="mb-2">
                                                        {{ source_type.source_type|capitalize }} 
                                                        <span class="badge bg-primary">{{ source_type.total }}</span>
                                                    </h6>
                                                    <div>
                                                        {% for source in source_type.sources[:5] %}
                                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                                <span>{{ source.source }}</span>
                                                                <span class="badge bg-secondary">{{ source.count }}</span>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 뉴스 상세 모달 -->
    <div class="modal fade" id="newsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newsModalTitle">뉴스 제목</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>출처:</strong> <span id="newsModalSource"></span>
                        <span class="ms-2 source-label" id="newsModalSourceType"></span>
                    </div>
                    <div class="mb-3">
                        <strong>발행일:</strong> <span id="newsModalDate"></span>
                    </div>
                    <div class="mb-3">
                        <strong>관련 심볼:</strong> <span id="newsModalSymbols"></span>
                    </div>
                    <div class="mb-3">
                        <strong>감성 분석:</strong>
                        <div class="progress mt-2" style="height: 20px;">
                            <div class="progress-bar bg-success" id="newsModalPositive" style="width: 0%">0%</div>
                            <div class="progress-bar bg-info" id="newsModalNeutral" style="width: 0%">0%</div>
                            <div class="progress-bar bg-danger" id="newsModalNegative" style="width: 0%">0%</div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small>긍정적</small>
                            <small>중립적</small>
                            <small>부정적</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>내용:</strong>
                        <p id="newsModalContent" class="mt-2"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="newsModalUrl" href="#" target="_blank" class="btn btn-primary">원문 보기</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white mt-5 py-3">
        <div class="container text-center">
            <p class="mb-0">© 2025 JaePa 금융 뉴스 분석 프로젝트</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 전역 변수 및 차트 객체
        let newsCollectionChart = null;
        let sentimentPieChart = null;
        let sentimentTrendChart = null;
        let sourceTypeChart = null;
        
        // DOM이 로드된 후 실행
        document.addEventListener('DOMContentLoaded', function() {
            // 초기 데이터 로드
            initializeSentimentPieChart();
            initializeSourceTypeChart();
            loadNews(7);
            updateNewsChart(7);
            updateSentimentChart(7);
            
            // 필터 이벤트 리스너
            document.getElementById('newsSourceFilter').addEventListener('change', function() {
                loadNews(7);
            });
            
            document.getElementById('symbolFilter').addEventListener('change', function() {
                updateSentimentChart(7);
            });
        });
        
        // 감성 파이 차트 초기화
        function initializeSentimentPieChart() {
            const ctx = document.getElementById('sentimentPieChart').getContext('2d');
            const sentiment = {
                positive: {{ sentiment_avg.positive }},
                neutral: {{ sentiment_avg.neutral }},
                negative: {{ sentiment_avg.negative }}
            };
            
            sentimentPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['긍정적', '중립적', '부정적'],
                    datasets: [{
                        data: [sentiment.positive, sentiment.neutral, sentiment.negative],
                        backgroundColor: ['#198754', '#0d6efd', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = Math.round(value * 100);
                                    return `${context.label}: ${percentage}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 소스 유형 차트 초기화
        function initializeSourceTypeChart() {
            const ctx = document.getElementById('sourceTypeChart').getContext('2d');
            const sourceData = [];
            const sourceLabels = [];
            
            {% for source_type in sources_count %}
                sourceLabels.push('{{ source_type.source_type }}');
                sourceData.push({{ source_type.total }});
            {% endfor %}
            
            sourceTypeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sourceLabels,
                    datasets: [{
                        data: sourceData,
                        backgroundColor: ['#20c997', '#0dcaf0', '#fd7e14'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // 뉴스 데이터 로드
        async function loadNews(days) {
            const sourceType = document.getElementById('newsSourceFilter').value;
            const newsListElement = document.getElementById('newsList');
            const loadingElement = document.getElementById('newsLoading');
            
            // 버튼 활성화 상태 업데이트
            updateButtonStates('button[onclick^="loadNews"]', days);
            
            // 로딩 표시
            newsListElement.innerHTML = '';
            loadingElement.style.display = 'flex';
            
            try {
                // API 호출
                let url = `/api/news?days=${days}&limit=20`;
                if (sourceType) {
                    url += `&source_type=${sourceType}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.news && data.news.length > 0) {
                    // 뉴스 목록 생성
                    let newsHtml = '';
                    
                    for (const news of data.news) {
                        // 감성 배지 생성
                        let sentimentBadge = '';
                        if (news.sentiment) {
                            const sentiment = news.sentiment;
                            let sentimentClass = '';
                            let sentimentText = '';
                            
                            if (sentiment.positive > sentiment.negative && sentiment.positive > sentiment.neutral) {
                                sentimentClass = 'sentiment-positive';
                                sentimentText = `긍정적 ${Math.round(sentiment.positive * 100)}%`;
                            } else if (sentiment.negative > sentiment.positive && sentiment.negative > sentiment.neutral) {
                                sentimentClass = 'sentiment-negative';
                                sentimentText = `부정적 ${Math.round(sentiment.negative * 100)}%`;
                            } else {
                                sentimentClass = 'sentiment-neutral';
                                sentimentText = `중립적 ${Math.round(sentiment.neutral * 100)}%`;
                            }
                            
                            sentimentBadge = `<span class="sentiment-badge ${sentimentClass}">${sentimentText}</span>`;
                        }
                        
                        // 관련 심볼 표시
                        let symbolsHtml = '';
                        if (news.related_symbols && news.related_symbols.length > 0) {
                            symbolsHtml = news.related_symbols.map(symbol => 
                                `<span class="symbol-badge">${symbol}</span>`
                            ).join(' ');
                        }
                        
                        // 소스 타입 라벨
                        const sourceTypeClass = `${news.source_type}-label`;
                        
                        // 날짜 형식 변환
                        const date = new Date(news.published_date);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        // 뉴스 카드 생성
                        newsHtml += `
                            <div class="list-group-item news-card p-3" onclick="showNewsModal(${JSON.stringify(news).replace(/"/g, '&quot;')})">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="mb-1">${news.title}</h5>
                                    ${sentimentBadge}
                                </div>
                                <p class="mb-2 text-truncate">${news.content || '내용 없음'}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small>
                                        <span class="source-label ${sourceTypeClass}">${news.source_type.toUpperCase()}</span>
                                        ${news.source}
                                    </small>
                                    <small class="text-muted">${formattedDate}</small>
                                </div>
                                ${symbolsHtml ? `<div class="mt-2">${symbolsHtml}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    newsListElement.innerHTML = newsHtml;
                } else {
                    newsListElement.innerHTML = `
                        <div class="list-group-item text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                            <p class="mt-3 text-muted">검색 결과가 없습니다.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('뉴스 로드 중 오류:', error);
                newsListElement.innerHTML = `
                    <div class="list-group-item text-center py-5">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                        <p class="mt-3 text-danger">데이터를 불러오는 중 오류가 발생했습니다.</p>
                    </div>
                `;
            } finally {
                // 로딩 표시 제거
                loadingElement.style.display = 'none';
            }
        }
        
        // 뉴스 모달 표시
        function showNewsModal(news) {
            const modal = new bootstrap.Modal(document.getElementById('newsModal'));
            
            // 모달 데이터 설정
            document.getElementById('newsModalTitle').textContent = news.title;
            document.getElementById('newsModalSource').textContent = news.source;
            document.getElementById('newsModalSourceType').textContent = news.source_type.toUpperCase();
            document.getElementById('newsModalSourceType').className = `source-label ${news.source_type}-label`;
            
            // 날짜 형식 변환
            const date = new Date(news.published_date);
            document.getElementById('newsModalDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            
            // 관련 심볼
            const symbolsElement = document.getElementById('newsModalSymbols');
            if (news.related_symbols && news.related_symbols.length > 0) {
                symbolsElement.innerHTML = news.related_symbols.map(symbol => 
                    `<span class="symbol-badge">${symbol}</span>`
                ).join(' ');
            } else {
                symbolsElement.innerHTML = '<span class="text-muted">없음</span>';
            }
            
            // 감성 분석
            if (news.sentiment) {
                const positive = Math.round(news.sentiment.positive * 100);
                const neutral = Math.round(news.sentiment.neutral * 100);
                const negative = Math.round(news.sentiment.negative * 100);
                
                document.getElementById('newsModalPositive').style.width = `${positive}%`;
                document.getElementById('newsModalPositive').textContent = `${positive}%`;
                
                document.getElementById('newsModalNeutral').style.width = `${neutral}%`;
                document.getElementById('newsModalNeutral').textContent = `${neutral}%`;
                
                document.getElementById('newsModalNegative').style.width = `${negative}%`;
                document.getElementById('newsModalNegative').textContent = `${negative}%`;
            } else {
                document.getElementById('newsModalPositive').style.width = '0%';
                document.getElementById('newsModalPositive').textContent = '0%';
                document.getElementById('newsModalNeutral').style.width = '0%';
                document.getElementById('newsModalNeutral').textContent = '0%';
                document.getElementById('newsModalNegative').style.width = '0%';
                document.getElementById('newsModalNegative').textContent = '0%';
            }
            
            // 내용
            document.getElementById('newsModalContent').textContent = news.content || '내용 없음';
            
            // URL 링크
            const urlElement = document.getElementById('newsModalUrl');
            if (news.url) {
                urlElement.href = news.url;
                urlElement.style.display = 'inline-block';
            } else {
                urlElement.style.display = 'none';
            }
            
            // 모달 표시
            modal.show();
        }
        
        // 뉴스 수집 트렌드 차트 업데이트
        async function updateNewsChart(days) {
            const ctx = document.getElementById('newsCollectionChart').getContext('2d');
            const loadingElement = document.getElementById('newsChartLoading');
            
            // 버튼 활성화 상태 업데이트
            updateButtonStates('button[onclick^="updateNewsChart"]', days);
            
            // 로딩 표시
            loadingElement.style.display = 'flex';
            
            try {
                // API 호출
                const response = await fetch(`/api/stats/news?days=${days}`);
                const data = await response.json();
                
                if (data.stats && data.stats.length > 0) {
                    const labels = data.stats.map(stat => stat.date);
                    
                    // 데이터셋 준비
                    const datasets = [];
                    
                    // 소스 유형별 데이터 추출
                    const sourceTypes = new Set();
                    data.stats.forEach(stat => {
                        Object.keys(stat).forEach(key => {
                            if (key !== 'date' && key !== 'total') {
                                sourceTypes.add(key);
                            }
                        });
                    });
                    
                    // 색상 정의
                    const colors = {
                        'rss': '#20c997',
                        'finnhub': '#0dcaf0',
                        'newsdata': '#fd7e14',
                        'total': '#6610f2'
                    };
                    
                    // 각 소스 유형별 데이터셋 생성
                    Array.from(sourceTypes).sort().forEach(sourceType => {
                        datasets.push({
                            label: sourceType.toUpperCase(),
                            data: data.stats.map(stat => stat[sourceType] || 0),
                            backgroundColor: colors[sourceType] || '#6c757d',
                            borderColor: colors[sourceType] || '#6c757d',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false
                        });
                    });
                    
                    // 합계 데이터셋 추가
                    datasets.push({
                        label: '합계',
                        data: data.stats.map(stat => stat.total),
                        backgroundColor: colors.total,
                        borderColor: colors.total,
                        borderWidth: 3,
                        tension: 0.3,
                        fill: false
                    });
                    
                    // 차트 생성 또는 업데이트
                    if (newsCollectionChart) {
                        newsCollectionChart.data.labels = labels;
                        newsCollectionChart.data.datasets = datasets;
                        newsCollectionChart.update();
                    } else {
                        newsCollectionChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: {
                                            parser: 'yyyy-MM-dd',
                                            tooltipFormat: 'yyyy-MM-dd',
                                            unit: 'day'
                                        },
                                        title: {
                                            display: true,
                                            text: '날짜'
                                        }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: '뉴스 수'
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        position: 'top'
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false
                                    }
                                }
                            }
                        });
                    }
                } else {
                    // 데이터가 없는 경우 차트 비우기
                    if (newsCollectionChart) {
                        newsCollectionChart.data.labels = [];
                        newsCollectionChart.data.datasets = [];
                        newsCollectionChart.update();
                    }
                }
            } catch (error) {
                console.error('뉴스 통계 로드 중 오류:', error);
                // 오류 시 차트 비우기
                if (newsCollectionChart) {
                    newsCollectionChart.data.labels = [];
                    newsCollectionChart.data.datasets = [];
                    newsCollectionChart.update();
                }
            } finally {
                // 로딩 표시 제거
                loadingElement.style.display = 'none';
            }
        }
        
        // 감성 트렌드 차트 업데이트
        async function updateSentimentChart(days) {
            const ctx = document.getElementById('sentimentTrendChart').getContext('2d');
            const loadingElement = document.getElementById('sentimentChartLoading');
            const symbol = document.getElementById('symbolFilter').value;
            
            // 버튼 활성화 상태 업데이트
            updateButtonStates('button[onclick^="updateSentimentChart"]', days);
            
            // 로딩 표시
            loadingElement.style.display = 'flex';
            
            try {
                // API 호출
                let url = `/api/stats/sentiment?days=${days}`;
                if (symbol) {
                    url += `&symbol=${symbol}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.stats && data.stats.length > 0) {
                    const labels = data.stats.map(stat => stat.date);
                    
                    // 데이터 집계
                    const dateGroups = {};
                    data.stats.forEach(stat => {
                        const date = stat.date;
                        if (!dateGroups[date]) {
                            dateGroups[date] = {
                                positive: 0,
                                neutral: 0,
                                negative: 0,
                                volume: 0,
                                count: 0
                            };
                        }
                        
                        // 가중치를 적용한 감성 점수 합산
                        const weight = stat.volume;
                        dateGroups[date].positive += stat.positive * weight;
                        dateGroups[date].neutral += stat.neutral * weight;
                        dateGroups[date].negative += stat.negative * weight;
                        dateGroups[date].volume += weight;
                        dateGroups[date].count += 1;
                    });
                    
                    // 평균 계산
                    const uniqueDates = [...new Set(labels)].sort();
                    const positiveData = uniqueDates.map(date => {
                        const group = dateGroups[date];
                        return group.volume > 0 ? group.positive / group.volume : 0;
                    });
                    
                    const neutralData = uniqueDates.map(date => {
                        const group = dateGroups[date];
                        return group.volume > 0 ? group.neutral / group.volume : 0;
                    });
                    
                    const negativeData = uniqueDates.map(date => {
                        const group = dateGroups[date];
                        return group.volume > 0 ? group.negative / group.volume : 0;
                    });
                    
                    const volumeData = uniqueDates.map(date => dateGroups[date].volume);
                    
                    // 차트 생성 또는 업데이트
                    if (sentimentTrendChart) {
                        sentimentTrendChart.data.labels = uniqueDates;
                        sentimentTrendChart.data.datasets = [
                            {
                                label: '긍정적',
                                data: positiveData,
                                backgroundColor: 'rgba(25, 135, 84, 0.2)',
                                borderColor: '#198754',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: '중립적',
                                data: neutralData,
                                backgroundColor: 'rgba(13, 110, 253, 0.2)',
                                borderColor: '#0d6efd',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: '부정적',
                                data: negativeData,
                                backgroundColor: 'rgba(220, 53, 69, 0.2)',
                                borderColor: '#dc3545',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: '뉴스 수',
                                data: volumeData,
                                backgroundColor: 'rgba(108, 117, 125, 0.5)',
                                borderColor: '#6c757d',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                type: 'bar',
                                yAxisID: 'y1'
                            }
                        ];
                        sentimentTrendChart.update();
                    } else {
                        sentimentTrendChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: uniqueDates,
                                datasets: [
                                    {
                                        label: '긍정적',
                                        data: positiveData,
                                        backgroundColor: 'rgba(25, 135, 84, 0.2)',
                                        borderColor: '#198754',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        fill: true,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: '중립적',
                                        data: neutralData,
                                        backgroundColor: 'rgba(13, 110, 253, 0.2)',
                                        borderColor: '#0d6efd',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        fill: true,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: '부정적',
                                        data: negativeData,
                                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                                        borderColor: '#dc3545',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        fill: true,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: '뉴스 수',
                                        data: volumeData,
                                        backgroundColor: 'rgba(108, 117, 125, 0.5)',
                                        borderColor: '#6c757d',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        type: 'bar',
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: {
                                            parser: 'yyyy-MM-dd',
                                            tooltipFormat: 'yyyy-MM-dd',
                                            unit: 'day'
                                        },
                                        title: {
                                            display: true,
                                            text: '날짜'
                                        }
                                    },
                                    y: {
                                        min: 0,
                                        max: 1,
                                        title: {
                                            display: true,
                                            text: '감성 점수'
                                        }
                                    },
                                    y1: {
                                        position: 'right',
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: '뉴스 수'
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        position: 'top'
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false
                                    }
                                }
                            }
                        });
                    }
                } else {
                    // 데이터가 없는 경우 차트 비우기
                    if (sentimentTrendChart) {
                        sentimentTrendChart.data.labels = [];
                        sentimentTrendChart.data.datasets = [];
                        sentimentTrendChart.update();
                    }
                }
            } catch (error) {
                console.error('감성 통계 로드 중 오류:', error);
                // 오류 시 차트 비우기
                if (sentimentTrendChart) {
                    sentimentTrendChart.data.labels = [];
                    sentimentTrendChart.data.datasets = [];
                    sentimentTrendChart.update();
                }
            } finally {
                // 로딩 표시 제거
                loadingElement.style.display = 'none';
            }
        }
        
        // 버튼 활성화 상태 업데이트
        function updateButtonStates(selector, days) {
            const buttons = document.querySelectorAll(selector);
            buttons.forEach(button => {
                const buttonDays = parseInt(button.getAttribute('onclick').match(/\d+/)[0]);
                if (buttonDays === days) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>
